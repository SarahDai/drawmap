<!doctype html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://gabelerner.github.io/canvg/rgbcolor.js"></script>
    <script type="text/javascript" src="http://gabelerner.github.io/canvg/StackBlur.js"></script>
    <script type="text/javascript" src="http://gabelerner.github.io/canvg/canvg.js"></script>

</head>
<body>
<script>

    $(document).ready(function () {
        // line generator
        var lineGen = d3.svg.line()
                .x(function (d, i) {
                    return getCanvLat(d.x);
                })
                .y(function (d, i) {
                    return getCanvLon(d.y);
                })
                .interpolate("monotone");

        // set up width and height of the canvas
        var maxminLatLon = {minLat: 22.433297, maxLat: 22.9765329, minLon: 113.6932913, maxLon: 114.7095769};
        var margin = {top: 20, right: 20, bottom: 30, left: 40};
        var wid = 2000;
        var width = wid - margin.left - margin.right;
        var height = (wid * (maxminLatLon.maxLon - maxminLatLon.minLon) / (maxminLatLon.maxLat - maxminLatLon.minLat)) - margin.top - margin.bottom;
        // var height = 2000;

        var svg = d3.select("body").append("svg")
                .attr("id", "map-svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)


        var file = "data/output.json";
        // var file = "data/output_original.json";

        d3.json(file, function (error, data) {

            // console.log(data);

            data.forEach(function (d) {

                var count = Math.random() * 60;

                if (count > 45) {
                    var line = svg.append('svg:path')
                            .attr('d', lineGen(d.path))
                            .attr('stroke', '#66ccff')
                            .attr('stroke-width', 5)
                            .attr('fill', 'none');
                }


                else if (count > 30) {
                    var line = svg.append('svg:path')
                            .attr('d', lineGen(d.path))
                            .attr('stroke', '#ff9980')
                            .attr('stroke-width', 5)
                            .attr('fill', 'none');
                }


                else if (count >= 15) {
                    var line = svg.append('svg:path')
                            .attr('d', lineGen(d.path))
                            .attr('stroke', '#80ff80')
                            .attr('stroke-width', 5)
                            .attr('fill', 'none');
                } else {
                    var line = svg.append('svg:path')
                            .attr('d', lineGen(d.path))
                            .attr('stroke', ' #d1d1e0')
                            .attr('stroke-width', 5)
                            .attr('fill', 'none');
                }


            });

            d3.select("body")
                    .append("button")
                    .html("Export")
                    .on("click", svgToCanvas);

        });

        function getCanvLat(lat) {
            return width / (maxminLatLon.maxLat - maxminLatLon.minLat ) * ( lat - maxminLatLon.minLat );
        }

        function getCanvLon(lon) {
            return height / ( maxminLatLon.maxLon - maxminLatLon.minLon ) * ( lon - maxminLatLon.minLon );
        }

        // Create the export function - this will just export
        // the first svg element it finds
        function svgToCanvas() {
            // Select the first svg element
            var svg = d3.select("svg")[0][0],
                    img = new Image(),
                    serializer = new XMLSerializer(),
                    svgStr = serializer.serializeToString(svg);

            img.src = 'data:image/svg+xml;base64,' + window.btoa(svgStr);

            // You could also use the actual string without base64 encoding it:
            //img.src = "data:image/svg+xml;utf8," + svgStr;

            var canvas = document.createElement("canvas");
            document.body.appendChild(canvas);

            canvas.width = width;
            canvas.height = height;
            canvas.getContext("2d").drawImage(img, 0, 0, width, height);
            // Now save as png or whatever
        };
    });


</script>

</body>
</html>
